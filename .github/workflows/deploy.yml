name: Deploy SECCO Tap Game to GitHub Pages

on:
  push:
    branches: 
      - main
      - master
  pull_request:
    branches: 
      - main
      - master

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§ª Validate HTML Files
        run: |
          echo "ğŸ” Validating HTML structure..."
          # Check if main files exist
          if [ ! -f "index.html" ]; then
            echo "âŒ index.html not found!"
            exit 1
          fi
          
          if [ ! -f "tonconnect-manifest.json" ]; then
            echo "âŒ tonconnect-manifest.json not found!"
            exit 1
          fi
          
          if [ ! -f "manifest.json" ]; then
            echo "âŒ manifest.json not found!"
            exit 1
          fi
          
          echo "âœ… All required files found!"

      - name: ğŸ”— Validate JSON Files
        run: |
          echo "ğŸ” Validating JSON files..."
          
          # Validate manifest.json
          if ! python -m json.tool manifest.json > /dev/null; then
            echo "âŒ manifest.json is invalid!"
            exit 1
          fi
          
          # Validate tonconnect-manifest.json
          if ! python -m json.tool tonconnect-manifest.json > /dev/null; then
            echo "âŒ tonconnect-manifest.json is invalid!"
            exit 1
          fi
          
          echo "âœ… JSON files are valid!"

      - name: ğŸŒ Test TON Connect Configuration
        run: |
          echo "ğŸ” Testing TON Connect manifest..."
          
          # Check required fields in tonconnect-manifest.json
          if ! grep -q '"url"' tonconnect-manifest.json; then
            echo "âŒ Missing 'url' in tonconnect-manifest.json"
            exit 1
          fi
          
          if ! grep -q '"name"' tonconnect-manifest.json; then
            echo "âŒ Missing 'name' in tonconnect-manifest.json"
            exit 1
          fi
          
          echo "âœ… TON Connect manifest is properly configured!"

      - name: ğŸ® Validate Game Structure
        run: |
          echo "ğŸ” Validating game structure..."
          
          # Check for essential game elements in index.html
          if ! grep -q "DOCTYPE html" index.html; then
            echo "âŒ Missing DOCTYPE in index.html"
            exit 1
          fi
          
          if ! grep -q "Telegram" index.html; then
            echo "âš ï¸ Warning: Telegram integration might be missing"
          fi
          
          if ! grep -q "TON" index.html; then
            echo "âš ï¸ Warning: TON Connect might be missing"
          fi
          
          echo "âœ… Game structure validated!"

      - name: ğŸ“Š Generate Build Report
        run: |
          echo "ğŸ“‹ Build Report" > build-report.txt
          echo "==============" >> build-report.txt
          echo "ğŸ“… Build Date: $(date)" >> build-report.txt
          echo "ğŸ”§ Build Number: ${{ github.run_number }}" >> build-report.txt
          echo "ğŸ“¦ Commit: ${{ github.sha }}" >> build-report.txt
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}" >> build-report.txt
          echo "" >> build-report.txt
          echo "ğŸ“ Files:" >> build-report.txt
          ls -la >> build-report.txt
          echo "" >> build-report.txt
          echo "ğŸ“ File Sizes:" >> build-report.txt
          du -h *.html *.json 2>/dev/null >> build-report.txt || true
          
          cat build-report.txt

      - name: ğŸ—œï¸ Optimize Files for Production
        run: |
          echo "ğŸ—œï¸ Optimizing files for production..."
          
          # Create production directory
          mkdir -p production
          
          # Copy essential files only
          cp index.html production/
          cp manifest.json production/
          cp tonconnect-manifest.json production/
          
          # Copy alternative versions if they exist
          [ -f index_new.html ] && cp index_new.html production/
          [ -f index_enhanced.html ] && cp index_enhanced.html production/
          
          echo "âœ… Files optimized for GitHub Pages!"
          echo "ğŸ“ Production files:"
          ls -la production/

      - name: ğŸ“¤ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'production'

  # Deployment job
  deploy:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸ‰ Successfully deployed SECCO Tap Game!"
          echo "ğŸŒ Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“± Game is now accessible via Telegram Web App!"
          echo "ğŸ”— TON Connect Manifest: ${{ steps.deployment.outputs.page_url }}tonconnect-manifest.json"

  # Post-deployment validation
  validate:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: ğŸ” Post-Deployment Validation
        run: |
          echo "ğŸ” Validating deployment..."
          
          # Wait a bit for deployment to be ready
          sleep 30
          
          # Test main page
          if curl -s -o /dev/null -w "%{http_code}" https://dmitrycoinsec.github.io/secco-tap-game/ | grep -q "200"; then
            echo "âœ… Main page is accessible"
          else
            echo "âŒ Main page is not accessible"
            exit 1
          fi
          
          # Test TON Connect manifest
          if curl -s -o /dev/null -w "%{http_code}" https://dmitrycoinsec.github.io/secco-tap-game/tonconnect-manifest.json | grep -q "200"; then
            echo "âœ… TON Connect manifest is accessible"
          else
            echo "âŒ TON Connect manifest is not accessible"
            exit 1
          fi
          
          # Test PWA manifest
          if curl -s -o /dev/null -w "%{http_code}" https://dmitrycoinsec.github.io/secco-tap-game/manifest.json | grep -q "200"; then
            echo "âœ… PWA manifest is accessible"
          else
            echo "âŒ PWA manifest is not accessible"
            exit 1
          fi
          
          echo "ğŸ‰ All post-deployment checks passed!"

      - name: ğŸ“§ Deployment Notification
        run: |
          echo "ğŸ“§ Deployment Notification"
          echo "=========================="
          echo "ğŸ® SECCO Tap Game has been successfully deployed!"
          echo "ğŸŒ Live URL: https://dmitrycoinsec.github.io/secco-tap-game/"
          echo "ğŸ“± Ready for Telegram Web App integration"
          echo "ğŸ’ TON Connect enabled for wallet functionality"
          echo "âš¡ Energy system: 100 energy / 12-hour refill"
          echo "ğŸš€ BlackRock is the past â€” CoinSecurities begins a new era!"
